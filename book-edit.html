<html>

<head>
    <script src="elements/typer-storage.js"></script>
    <link rel="stylesheet" href="main.css" />
    <style>
        textarea {
            width: 100%;
            height: 80%;
        }
    </style>

    <script>
        function init() {
            const id = new URLSearchParams(window.location.search).get('id');
            if (!id)
                window.location = `book-new`;

            const form = document.getElementsByTagName('form')[0];

            const storage = this.document.getElementsByTagName('typer-storage')[0];
            const title = (storage.loadBookList() || {})[id]?.title;

            if (title) {
                form[0].value = title;
            }

            const data = storage.loadBookData(id) || {};

            if (!data.chapters)
                return;

            var content = '';

            data.chapters.forEach(f => {
                content += `###${f.title}\n`;
                f.sections.forEach(g => {
                    content += `##${g.title}\n`;
                    content += `${g.text}\n`;
                });
            });

            form[1].value = content;
        }

        function submitForm(e, form) {
            e.preventDefault();

            const id = new URLSearchParams(window.location.search).get('id');

            //const ideal_word_count_per_section = 30 * 3;

            const storage = this.document.getElementsByTagName('typer-storage')[0];

            const list = (storage.loadBookList() || {});
            if (!list[id])
                list[id] = {};
            list[id].title = form[0].value;
            storage.saveBookList(list);

            const lines = form[1].value.split('\n');

            var data = { chapters: [] };
            var chapter = { title: '', sections: [] };
            var section = { text: '' };
            data.chapters.push(chapter);

            lines.forEach(f => {

                if (f.startsWith("###")) {
                    const chapterName = f.split("###")[1];
                    if (!chapter.title)
                        chapter.title = chapterName;
                    else {
                        chapter = { title: chapterName, sections: [] };
                        data.chapters.push(chapter);
                    }

                    if (section.text.length > 0) {
                        chapter.sections.push(section);
                        section = { text: ''};
                    }
                    
                    return;
                }

                if (f.startsWith("##")) {
                    const sectionName = f.split("##")[1];
                    if(!section.title){
                        section.title = sectionName;
                    }else{
                    chapter.sections.push(section);
                    section = { title: sectionName, text: ''};
                    }
                }
                else{
                    section.text += `${f}\n`;
                    }
            });

            if(section.text != '')
                chapter.sections.push(section);

            storage.saveBookData(id, data);

            window.location = '/';
        }
    </script>
</head>

<body onload="init()">
    <typer-storage></typer-storage>
    <form onsubmit="submitForm(event, this)">
        <label>Book title</label>
        <br>
        <input type="text">
        <br>
        <br>
        <label>Book content</label>
        <br>
        <textarea name="content" autofocus></textarea>
        <br>
        <br>
        <button>save</button>
    </form>
</body>



</html>